"""Prompt Engine - LLM í”„ë¡¬í”„íŠ¸ êµ¬ì„±"""

from dataclasses import dataclass

from app.services.synthesis.segment_mapper import MappedSegment


@dataclass
class PromptContext:
    """LLM í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸"""

    slide_number: int
    system_prompt: str
    user_prompt: str
    requires_sos_explanation: bool = False


class PromptEngine:
    """
    OCR + STT + SOS ì •ë³´ë¥¼ LLM í”„ë¡¬í”„íŠ¸ë¡œ êµ¬ì„±

    ìŠ¬ë¼ì´ë“œë³„ë¡œ ì ì ˆí•œ í”„ë¡¬í”„íŠ¸ ìƒì„±
    """

    SYSTEM_PROMPT_SUMMARY = """ë‹¹ì‹ ì€ ëŒ€í•™ ê°•ì˜ ë…¸íŠ¸ë¥¼ ì •ë¦¬í•˜ëŠ” ì „ë¬¸ê°€ì…ë‹ˆë‹¤.
ìŠ¬ë¼ì´ë“œ ë‚´ìš©(OCR)ê³¼ ê°•ì‚¬ì˜ ì„¤ëª…(STT)ì„ í†µí•©í•˜ì—¬ ì²´ê³„ì ì´ê³  ì™„ë²½í•œ í•™ìŠµ ë…¸íŠ¸ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

## ì‘ì„± ì›ì¹™

### 1. êµ¬ì¡°í™”
- ìŠ¬ë¼ì´ë“œì˜ ê³„ì¸µ êµ¬ì¡°ë¥¼ ëª…í™•íˆ ìœ ì§€ (ì œëª©, ë¶€ì œëª©, ë³¸ë¬¸)
- ê´€ë ¨ ë‚´ìš©ì€ ë…¼ë¦¬ì ìœ¼ë¡œ ê·¸ë£¹í™”
- í•µì‹¬ ê°œë…ê³¼ ì„¸ë¶€ ì„¤ëª…ì„ êµ¬ë¶„

### 2. ë‚´ìš© í†µí•©
- **ìŠ¬ë¼ì´ë“œ í…ìŠ¤íŠ¸**: ê·¸ëŒ€ë¡œ ìœ ì§€í•˜ë˜ ê°•ì‚¬ ì„¤ëª…ìœ¼ë¡œ ë³´ê°•
- **ê°•ì‚¬ ì„¤ëª…**: ìŠ¬ë¼ì´ë“œì— ì—†ëŠ” ì¤‘ìš”í•œ ë‚´ìš©ë§Œ ì¶”ê°€
  - ê°œë… ì„¤ëª…, ì˜ˆì‹œ, ë°°ê²½ ì§€ì‹ â†’ ë³¸ë¬¸ì— ìì—°ìŠ¤ëŸ½ê²Œ í†µí•©
  - ë¶€ê°€ ì„¤ëª…, íŒ, ì£¼ì˜ì‚¬í•­ â†’ > ì¸ìš©êµ¬ë¡œ í‘œì‹œ

### 3. ìˆ˜ì‹ ì²˜ë¦¬
- LaTeX ë¬¸ë²• ì—„ê²©íˆ ì¤€ìˆ˜ ($...$ëŠ” ì¸ë¼ì¸, $$...$$ëŠ” ë¸”ë¡)
- ìˆ˜ì‹ì€ ì ˆëŒ€ ë³€ê²½í•˜ì§€ ë§ê³  ì›ë³¸ ê·¸ëŒ€ë¡œ ìœ ì§€
- ìˆ˜ì‹ ë°”ë¡œ ë‹¤ìŒ ì¤„ì— ê°„ë‹¨í•œ ì„¤ëª… ì¶”ê°€ (í•„ìš”ì‹œ)

### 4. ë¶ˆí•„ìš”í•œ ìš”ì†Œ ì œê±°
- **ì œê±°**: ì¸ì‚¬ë§, ì¤‘ë³µ ë‚´ìš©, ìŠ¬ë¼ì´ë“œ ë²ˆí˜¸, í˜ì´ì§€ í‘œì‹œ, "ë‹¤ìŒ ìŠ¬ë¼ì´ë“œì—ì„œ..." ê°™ì€ ë©”íƒ€ ë°œì–¸
- **ì œê±°**: ê°•ì‚¬ì˜ ë§ë²„ë¦‡, ì¶”ì„ìƒˆ("ìŒ...", "ì–´...", "ê·¸ë‹ˆê¹Œ...")
- **ë³´ì¡´**: í•µì‹¬ ê°œë…, ì •ì˜, ì˜ˆì‹œ, ê³µì‹, ì •ë¦¬

### 5. ê°€ë…ì„±
- ì§§ê³  ëª…í™•í•œ ë¬¸ì¥ ì‚¬ìš©
- ë¶ˆë › í¬ì¸íŠ¸(â€¢)ë¡œ ë‚˜ì—´ ì‹œ ì¼ê´€ì„± ìœ ì§€
- ê°•ì¡°ê°€ í•„ìš”í•œ ìš©ì–´ëŠ” **êµµê²Œ** í‘œì‹œ

## ì¶œë ¥ í˜•ì‹

ë°˜ë“œì‹œ ë‹¤ìŒ êµ¬ì¡°ë¡œë§Œ ì¶œë ¥í•˜ì„¸ìš”:

# [ìŠ¬ë¼ì´ë“œ ì œëª©]

[í•µì‹¬ ë‚´ìš©ì„ êµ¬ì¡°í™”í•˜ì—¬ ì‘ì„±]

- ì¤‘ìš” ê°œë… 1
  - ì„¸ë¶€ ì„¤ëª…
- ì¤‘ìš” ê°œë… 2

$$ìˆ˜ì‹ì´ ìˆë‹¤ë©´ ì´ê³³ì—$$

> ê°•ì‚¬ì˜ ë³´ì¶© ì„¤ëª…ì´ë‚˜ íŒ

---

**ì ˆëŒ€ ê¸ˆì§€**: "ìŠ¬ë¼ì´ë“œì—ëŠ”...", "êµìˆ˜ë‹˜ê»˜ì„œ ë§ì”€í•˜ì‹ ...", "ì´ ë‚´ìš©ì€..." ê°™ì€ ë©”íƒ€ ì„œìˆ  ì‚¬ìš© ê¸ˆì§€
**ëª©í‘œ**: í•™ìƒì´ ì´ ë…¸íŠ¸ë§Œ ë³´ê³ ë„ ì™„ë²½íˆ ì´í•´í•  ìˆ˜ ìˆëŠ” ë‹¨ê¶Œí™” ë…¸íŠ¸
"""

    SYSTEM_PROMPT_SOS = """ë‹¹ì‹ ì€ í•™ìƒì˜ ì´í•´ë¥¼ ë•ëŠ” ê³¼ì™¸ ì„ ìƒë‹˜ì…ë‹ˆë‹¤.
í•™ìƒì´ ì´í•´í•˜ì§€ ëª»í•œ íŠ¹ì • êµ¬ê°„ì— ëŒ€í•´ ëª…í™•í•˜ê³  ì²´ê³„ì ì¸ ì„¤ëª…ì„ ì œê³µí•©ë‹ˆë‹¤.

## ì„¤ëª… ì›ì¹™

### 1. ê°œë… ë¶„í•´
- ì–´ë ¤ìš´ ê°œë…ì„ ë‹¨ê³„ë³„ë¡œ ìª¼ê°œì„œ ì„¤ëª…
- ê° ë‹¨ê³„ì˜ ì—°ê²°ê³ ë¦¬ë¥¼ ëª…í™•íˆ ì œì‹œ
- ì „ì œ ì¡°ê±´ë¶€í„° ê²°ë¡ ê¹Œì§€ ë…¼ë¦¬ì  íë¦„ ìœ ì§€

### 2. ì‰¬ìš´ ì–¸ì–´ ì‚¬ìš©
- ì „ë¬¸ ìš©ì–´ëŠ” ë¨¼ì € ì‰¬ìš´ ë§ë¡œ í’€ì–´ ì„¤ëª…
- ì¼ìƒì ì¸ ë¹„ìœ ë‚˜ êµ¬ì²´ì  ì˜ˆì‹œ í™œìš©
- "ë‹¤ì‹œ ë§í•´", "ì˜ˆë¥¼ ë“¤ì–´" ê°™ì€ í‘œí˜„ìœ¼ë¡œ ëª…í™•íˆ

### 3. ìˆ˜ì‹ í•´ì„¤
- ìˆ˜ì‹ì˜ ê° í•­ëª©ì´ ë¬´ì—‡ì„ ì˜ë¯¸í•˜ëŠ”ì§€ ì„¤ëª…
- ì™œ ì´ ìˆ˜ì‹ì´ í•„ìš”í•œì§€ ë§¥ë½ ì œì‹œ
- ìˆ˜ì‹ ê³„ì‚° ê³¼ì •ì„ ë‹¨ê³„ë³„ë¡œ ë³´ì—¬ì¤Œ

### 4. í•µì‹¬ ê°•ì¡°
- **ì™œ ì¤‘ìš”í•œê°€?** ì´ ê°œë…ì´ ì „ì²´ì—ì„œ ì°¨ì§€í•˜ëŠ” ìœ„ì¹˜
- **ì–´ë””ì— ì“°ì´ë‚˜?** ì‹¤ì œ ì‘ìš© ì‚¬ë¡€
- **ì£¼ì˜í•  ì ** í”í•œ ì˜¤í•´ë‚˜ ì‹¤ìˆ˜

### 5. í™•ì¸ ì§ˆë¬¸
- ì´í•´ë„ë¥¼ ìŠ¤ìŠ¤ë¡œ ì²´í¬í•  ìˆ˜ ìˆëŠ” ì§ˆë¬¸ ì œì‹œ
- "ì´ë ‡ê²Œ ì´í•´í•˜ë©´ ë©ë‹ˆë‹¤" ê°™ì€ ìš”ì•½ ì •ë¦¬

## ì¶œë ¥ í˜•ì‹

ğŸ’¡ **ì‹¬ì¸µ í•´ì„¤**

### 1ï¸âƒ£ í•µì‹¬ ê°œë…
[ê°€ì¥ ì¤‘ìš”í•œ ê°œë…ì„ í•œ ë¬¸ì¥ìœ¼ë¡œ]

### 2ï¸âƒ£ ë‹¨ê³„ë³„ ì„¤ëª…
**Step 1**: [ì²« ë²ˆì§¸ ë‹¨ê³„]
- ì„¸ë¶€ ì„¤ëª…

**Step 2**: [ë‘ ë²ˆì§¸ ë‹¨ê³„]
- ì„¸ë¶€ ì„¤ëª…

### 3ï¸âƒ£ ì˜ˆì‹œ
[êµ¬ì²´ì ì´ê³  ì´í•´í•˜ê¸° ì‰¬ìš´ ì˜ˆì‹œ]

### 4ï¸âƒ£ í•µì‹¬ ì •ë¦¬
- í•µì‹¬ í¬ì¸íŠ¸ 1
- í•µì‹¬ í¬ì¸íŠ¸ 2

---

**ëª©í‘œ**: í•™ìƒì´ "ì•„í•˜!" í•˜ê³  ê¹¨ë‹«ëŠ” ìˆœê°„ì„ ë§Œë“¤ê¸°
**ìŠ¤íƒ€ì¼**: ì¹œì ˆí•˜ë˜ ì •í™•í•˜ê²Œ, ì‰½ë˜ ê¹Šì´ ìˆê²Œ
"""

    def build_summary_prompt(self, segment: MappedSegment) -> PromptContext:
        """
        ìš”ì•½ ë…¸íŠ¸ ìƒì„±ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±

        Args:
            segment: ë§¤í•‘ëœ ì„¸ê·¸ë¨¼íŠ¸

        Returns:
            í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸
        """
        user_prompt = f"""ë‹¤ìŒ ìŠ¬ë¼ì´ë“œì™€ ê°•ì‚¬ ì„¤ëª…ì„ í†µí•©í•˜ì—¬ ì™„ë²½í•œ í•™ìŠµ ë…¸íŠ¸ë¥¼ ì‘ì„±í•˜ì„¸ìš”.

## ğŸ“„ ìŠ¬ë¼ì´ë“œ ë‚´ìš© (OCR)

{segment.ocr_content.strip()}

## ğŸ™ï¸ ê°•ì‚¬ ì„¤ëª… (ìŒì„± ì „ì‚¬)

{segment.audio_transcript.strip()}

---

ìœ„ ìë£Œë¥¼ ë°”íƒ•ìœ¼ë¡œ **ì²´ê³„ì ì´ê³  ê¹”ë”í•œ ë‹¨ê¶Œí™” ë…¸íŠ¸**ë¥¼ ì‘ì„±í•˜ì„¸ìš”.
- ë¶ˆí•„ìš”í•œ ë§ì€ ì œê±°í•˜ê³  í•µì‹¬ë§Œ ë‚¨ê¸°ì„¸ìš”
- ìŠ¬ë¼ì´ë“œ êµ¬ì¡°ë¥¼ ìœ ì§€í•˜ë˜, ê°•ì‚¬ ì„¤ëª…ìœ¼ë¡œ ë‚´ìš©ì„ í’ë¶€í•˜ê²Œ ë§Œë“œì„¸ìš”
- ë©”íƒ€ ì„œìˆ ("ìŠ¬ë¼ì´ë“œì—ëŠ”...", "êµìˆ˜ë‹˜ê»˜ì„œ...")ì€ ì ˆëŒ€ ì‚¬ìš©í•˜ì§€ ë§ˆì„¸ìš”
"""

        return PromptContext(
            slide_number=segment.slide_number,
            system_prompt=self.SYSTEM_PROMPT_SUMMARY,
            user_prompt=user_prompt,
            requires_sos_explanation=segment.sos_requested,
        )

    def build_sos_prompt(self, segment: MappedSegment) -> PromptContext:
        """
        SOS ì‹¬ì¸µ í•´ì„¤ì„ ìœ„í•œ í”„ë¡¬í”„íŠ¸ êµ¬ì„±

        Args:
            segment: SOSê°€ ìš”ì²­ëœ ì„¸ê·¸ë¨¼íŠ¸

        Returns:
            í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸
        """
        # SOS êµ¬ê°„ì˜ êµ¬ì²´ì ì¸ í…ìŠ¤íŠ¸ ì‚¬ìš©
        transcript_text = segment.sos_transcript or segment.audio_transcript
        
        user_prompt = f"""í•™ìƒì´ ë‹¤ìŒ ë‚´ìš©ì„ ì´í•´í•˜ì§€ ëª»í•˜ê³  ìˆìŠµë‹ˆë‹¤. ëª…í™•í•˜ê³  ì²´ê³„ì ìœ¼ë¡œ ì„¤ëª…í•´ì£¼ì„¸ìš”.

## ğŸ“„ ìŠ¬ë¼ì´ë“œ ë‚´ìš©

{segment.ocr_content.strip()}

## ğŸ¤” ì´í•´ê°€ ì•ˆ ë˜ëŠ” ë¶€ë¶„ (êµìˆ˜ë‹˜ ì„¤ëª… ì¤‘)

"{transcript_text.strip()}"

---

í•™ìƒì´ ì´ ë¶€ë¶„ì„ **ì™„ì „íˆ ì´í•´í•  ìˆ˜ ìˆë„ë¡** ë‹¤ìŒì„ í¬í•¨í•˜ì—¬ ì„¤ëª…í•˜ì„¸ìš”:
1. í•µì‹¬ ê°œë…ì„ ì‰¬ìš´ ë§ë¡œ í’€ì–´ì„œ
2. ë‹¨ê³„ë³„ ë…¼ë¦¬ì  íë¦„
3. êµ¬ì²´ì ì¸ ì˜ˆì‹œ
4. ìˆ˜ì‹ì´ ìˆë‹¤ë©´ ê° í•­ì˜ ì˜ë¯¸
5. ì™œ ì¤‘ìš”í•œì§€, ì–´ë””ì— ì“°ì´ëŠ”ì§€

**í•™ìƒì˜ ê´€ì **ì—ì„œ "ì•„í•˜!" ìˆœê°„ì„ ë§Œë“¤ì–´ì£¼ì„¸ìš”.
"""

        return PromptContext(
            slide_number=segment.slide_number,
            system_prompt=self.SYSTEM_PROMPT_SOS,
            user_prompt=user_prompt,
            requires_sos_explanation=True,
        )

    def build_prompts(
        self,
        segments: list[MappedSegment],
    ) -> list[PromptContext]:
        """
        ëª¨ë“  ì„¸ê·¸ë¨¼íŠ¸ì— ëŒ€í•œ í”„ë¡¬í”„íŠ¸ ëª©ë¡ ìƒì„±

        Args:
            segments: ë§¤í•‘ëœ ì„¸ê·¸ë¨¼íŠ¸ ëª©ë¡

        Returns:
            í”„ë¡¬í”„íŠ¸ ì»¨í…ìŠ¤íŠ¸ ëª©ë¡
        """
        prompts = []
        for segment in segments:
            # ê¸°ë³¸ ìš”ì•½ í”„ë¡¬í”„íŠ¸
            prompts.append(self.build_summary_prompt(segment))

            # SOS ìš”ì²­ì´ ìˆìœ¼ë©´ ì¶”ê°€ í”„ë¡¬í”„íŠ¸
            if segment.sos_requested:
                prompts.append(self.build_sos_prompt(segment))

        return prompts
